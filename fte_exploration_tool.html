<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<script src="http://d3js.org/d3.v3.min.js"></script>
	<style>
	.hover {
		font-family: "Courier New";
		font-style: italic;
		font-size: 10px;
	}

	.axis path,
	.axis line {
		fill: none;
		stroke: black;
		shape-rendering: crispEdges;
	}

	.axis text {
		font-family: sans-serif;
		font-size: 11px;
	}

	.dyn-axis path,
	.dyn-axis line {
		fill: none;
		stroke: black;
		shape-rendering: crispEdges;
	}

	.dyn-axis text {
		font-family: sans-serif;
		font-size: 11px;
	}
	</style>

	<script type="text/javascript">
	function graph(fteData){


		"use strict";
		var margin=75,
			width=900 - margin,
			height=350 - margin;

		d3.select('body')
			.append('h2')
			.text('FTE Exploration Tool');

		d3.select('body')
			.append('h3')
			.text('In Progress')

		var svg1=d3.select('body')
			.append('svg')
			.attr('width', width+margin)
			.attr('height', height+margin)
			.append('g')
			.attr('class', 'top_graph');

		var svg2=d3.select('body')
			.append('svg')
			.attr('width', 600)
			.attr('height', height+margin)
			.append('g')
			.attr('class', 'side_graph')



		var barspacing= 11

		var barwidth=10

		var padding = 40;

		var yAxisPadding=padding-5;

		//first graph for this year only

		var currentYear=fteData.filter(function(d){
			return d['year']=='2016-17'
		})

		var textspacing=2

		function mouse_hover(data, index, xaxis, text, value){
									svg1.append('text')
								   			.attr('class', 'hover')
								   			.text(text + ': ' + Math.round(value*100)/100)
								   			.attr('x', (index * barspacing) + textspacing * 8 + 2.5 + padding)
								   			.attr('y', xaxis + 23)
								   			.attr('fill', 'white')
								   			.transition()
								   			.delay(400)
								   			.duration(300)
								   			.attr('fill', 'black')
								   		svg1.append("line")
								   			.attr('class', 'hover')
								   			.style('stroke-dasharray', ('3, 3'))
								   			.attr('x1', index * barspacing + textspacing + padding)
								   			.attr('y1', xaxis + 5)
								   			.attr('x2', index * barspacing + textspacing + padding)
								   			.attr('y2', xaxis + 5)
								   			.transition()
								   			.duration(200)
								   			.attr('x2', (index * barspacing) + textspacing * 4 + padding)
								   			.attr('y2', xaxis + 20)
								   			.attr('stroke-width', 1)
								   			.attr('stroke', 'black')

								   		svg1.append('line')
								   			.attr('class', 'hover')
								   			.style('stroke-dasharray', ('3, 3'))
								   			.attr('x1', (index * barspacing) + textspacing * 4 + padding)
								   			.attr('y1', xaxis + 20)
								   			.attr('x2', (index * barspacing) + textspacing * 4 + padding)
								   			.attr('y2', xaxis + 20)
								   			.transition()
								   			.delay(200)
								   			.duration(200)
								   			.attr('x2', (index * barspacing) + textspacing * 8 + padding)
								   			.attr('y2', xaxis + 20)
								   			.attr('stroke-width', 1)
								   			.attr('stroke', 'black')
								}

		function mouse_out(){
			d3.selectAll('.hover')
				.transition()
				.duration(300)
				.attr('opacity', 0)
				.remove()
		}


		

		var currentNested=d3.nest()
					.key(function(d){
						return d['programTitle'];
					})
					.rollup(function(leaves){
						var fte=d3.sum(leaves, function(d){
							return +d['sumFTE'];
						});


						return {
							'fte': fte,
						}


					})
					.entries(currentYear)

		var maxFTEs = d3.max(currentNested, function(d){
			return d.values['fte'];
		})

		var xaxisGraphOne = 200

		var bar1Scale = d3.scale.linear()
							.domain([0, maxFTEs])
							.range([0, xaxisGraphOne])

		var AxisScale = d3.scale.linear()
							.domain([maxFTEs, 0])
							.range([0, xaxisGraphOne])


		var yAxis1 = d3.svg.axis().scale(AxisScale).orient('left')

		

		svg1.selectAll('.currentTotal')
			.data(currentNested.sort(function(a, b){return b.values['fte'] - a.values['fte'];}))
			.enter()
			.append('g')
			.append('rect')
			.attr('class', 'currentTotal')
			.attr('x', function(d, i){return i * barspacing + padding})
			.attr('y', function(d){return xaxisGraphOne;})
			.attr('height', 0)
			.attr('width', barwidth)
			.attr('fill', 'black')
			.attr('id', function(d){
				return d['key'].replace(/\s/g, "");
			})
			.attr('opacity', 0.2)
			.on('mouseover', function(d, i){

				

				d3.select(this).attr('opacity', 1)


				mouse_hover(d, i, xaxisGraphOne, d['key'], d.values['fte']);

				let hovered = d['key'].replace(/\s/g, "")
				d3.selectAll("#" + hovered).attr('opacity', 1)
				
			})
			.on('mouseout', function(d){
				let hovered = d['key'].replace(/\s/g, "")

				d3.select(this)
					.attr('opacity', 0.2)

				mouse_out();

				d3.selectAll('#' + hovered).attr('opacity', 0.2)
				
			})
			.transition()
			.duration(300)
			.delay(function(d, i){return i * 25})
			.attr('y', function(d){
				return xaxisGraphOne - bar1Scale(d.values['fte']);
			})
			.attr('height', function(d){
				return bar1Scale(d.values['fte']);
			})
			

		

		

		var yAxisGroup = svg1.append('g')
			.attr('class', 'axis')
			.attr('transform', 'translate(' + yAxisPadding + ',0)')
			.call(yAxis1)

	
		function delta_graph(deltaData){

			var xaxisDeltaGraph=320

			var delta_maxFTEs =d3.max(deltaData, function(d){
				return +d['delta'];
			})

			var delta_minFTEs = d3.min(deltaData, function(d){
				return +d['delta'];
			})





			

			var bar2Scale = d3.scale.linear()
				.domain([0, delta_maxFTEs])
				.range([0, 90])

			var axis2Scale = d3.scale.linear().domain([delta_maxFTEs, 0]).range([0, 90])

			var yAxis2 = d3.svg.axis().scale(axis2Scale).orient('left')

			var yAxisGroup = svg1.append('g')
				.attr('class', 'axis')
				.attr('transform', 'translate(' + yAxisPadding + ',' + (xaxisDeltaGraph - bar2Scale(delta_maxFTEs)) +')')
				.call(yAxis2)

			svg1.selectAll('.currentDelta')
				.data(deltaData.sort(function(a, b){return a['delta'] - b['delta'];}))
				.enter()
				.append('g')
				.append('rect')
				.attr('class', 'currentDelta')
				.attr('x', function(d, i){return i * barspacing + padding})
				.attr('y', function(d){
					return xaxisDeltaGraph;
				})
				.attr('width', barwidth)
				.attr('height', 0)
				.attr('fill', function(d){
					return d['delta'] > 0? 'green': 'red';
				})
				.attr('opacity', 0.2)
				.attr('id', function(d){
					return d['programID'];
				})
				.on('mouseover', function(d, i){
					d3.select(this)
						.attr('opacity', 1)

					mouse_hover(d, i, xaxisDeltaGraph, d['programTitle'], d['delta']);

					let hovered = d['programID'].replace(/\s/g, "")
					d3.selectAll("#" + hovered).attr('opacity', 1)
				})
				.on('mouseout', function(d){
					d3.select(this).attr('opacity', 0.2)

					mouse_out();

					let hovered = d['programID'].replace(/\s/g, "")
					d3.selectAll("#" + hovered).attr('opacity', 0.2)
				})
				.on('click', function(d){


					///////////////////
					// DETAIL GRAPHS //
					///////////////////




					d3.selectAll('.yearGraph').remove()
					d3.selectAll('.dyn-axis').remove()
					d3.selectAll('.studentDistribution').remove()

					var yearGraph_xaxis=200

					let clicked=d['programTitle'];

					let filteredData=fteData.filter(function(d){
						return d['programTitle']==clicked;
					})

					

					
					

					let filteredRollup=d3.nest()
						.key(function(d){
							return d['year'];
						})
						.rollup(function(leaves){
							var fte=d3.sum(leaves, function(d){
								return d['sumFTE']
							})

							return {
								'fte': fte
							}
						})
						.entries(filteredData)

					let yearMaxFTEs = d3.max(filteredRollup, function(d){
						return +d.values['fte'];
					})

					var bar3scale = d3.scale.linear()
						.domain([0, yearMaxFTEs])
						.range([0, 200])

					var xAxis3Scale = d3.scale.linear()
						.domain([2009, 2017])
						.range([0, (barspacing) * (2017-2009)])

					var yAxis3Scale = d3.scale.linear()
						.domain([yearMaxFTEs, 0])
						.range([0, yearGraph_xaxis])

					var xAxis3 = d3.svg.axis().scale(xAxis3Scale).orient('bottom').tickFormat(d3.format('d'))

					var xAxis3line = svg2.append('g')
						.attr('class', 'dyn-axis')
						.attr('transform', 'translate(' + (padding) + ',' + yearGraph_xaxis + ')')
						.call(xAxis3.ticks(4))
							.selectAll('text')
							.style('text-anchor', 'end')
							.attr('dx', '3em')
							.attr('transform', 'rotate(45)')

					var yAxis3 = d3.svg.axis().scale(yAxis3Scale).orient('left')

					var yAxis3line = svg2.append('g')
						.attr('class', 'dyn-axis')
						.attr('transform', 'translate(' + yAxisPadding + ',' + (yearGraph_xaxis - bar3scale(yearMaxFTEs)) + ')')
						.call(yAxis3)

					

					svg2.selectAll('.yearGraph')
						.data(filteredRollup)
						.enter()
						.append('g')
						.append('rect')
						.attr('class', 'yearGraph')
						.attr('y', function(d){
							return yearGraph_xaxis
						})
						.attr('height', 0)
						

						.attr('x', function(d, i){return (d['key'].substring(0, 4)-2009) * barspacing + padding;})
						
						.attr('width', barwidth)
						.attr('opacity', 0.2)
						.on('mouseover', function(d){
							d3.select(this).attr('opacity', 1)
						})
						.on('mouseout', function(d){
							d3.select(this).attr('opacity', 0.2)
						})
						.transition()
						.duration(300)
						.delay(function(d, i){return i * 50;})
						.attr('height', function(d){
							return bar3scale(d.values['fte']);
						})
						.attr('y', function(d){
							return yearGraph_xaxis - bar3scale(d.values['fte']);
						})
						
						

					d3.csv('studentData2.csv', fte_distribution)

					function fte_distribution(distributionData){

						var values = distributionData.filter(function(d){
							return d['programTitle']==clicked;
						})


						let raw = d3.nest()
									.key(function(d){return d['fte']})
									.rollup(function(leaves){
			
										var count=d3.sum(leaves, function(d){

											return +d['count']


										})

										return {
											'count': count
										}
								
									})
									.entries(values)

						let distribution_height = yearGraph_xaxis
						
						let distribution_width=300

						var maxCount = d3.max(raw, function(d){return d.values['count']})

						let distribution_offset=300

						var bar4scale=d3.scale.linear()
							.domain([0, maxCount])
							.range([0, distribution_width])

					
						svg2.selectAll('.studentDistribution')
							.data(raw)
							.enter()
							.append('g')
							.append('rect')
							.attr('class', 'studentDistribution')
							.attr('y', function(d){
								return distribution_height - bar4scale(d.values['count'])
							})
							.attr('x', function(d){
								return distribution_offset + (+d['key']*50)
							})
							.attr('height', function(d){
								return bar4scale(d.values['count']);
							})
							.attr('width', 5)


					}

				})
				.transition()
				.duration(200)
				.delay(function(d, i){return i * 25})
				.attr('height', function(d){
					return bar2Scale(Math.abs(d['delta']));
				})
				.attr('y', function(d){
					return xaxisDeltaGraph - bar2Scale(Math.abs(d['delta']));
				})



			

		}
		


		d3.csv('fteDelta.csv', delta_graph)
	}

	</script>
</head>


<body>
	<script type="text/javascript">
		d3.csv("fteData.csv", graph); 
	</script>





</body>
</html>